<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body { font-family: 'Sarabun', sans-serif; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.image-preview { transition: all 0.3s ease; }
.image-preview:hover { transform: scale(1.05); }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- Header -->
<div class="bg-white shadow-lg border-b-4 border-blue-500">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <div class="flex justify-center mt-4 space-x-4">
            <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
</div>

<!-- Progress -->
<div class="container mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
            <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Tasks -->
<div id="tasksContent" class="container mx-auto px-4 pb-8">
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
            </select>
            <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
            <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            </select>
            <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>

<!-- Summary -->
<div id="summaryContent" class="container mx-auto px-4 pb-8 hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>
        <div id="summaryTable" class="overflow-x-auto"></div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-full max-h-full overflow-auto">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="imageModalContent" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

<!-- Firebase + Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, update, get, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDxHYua4i21OV_N5Me_5ORsQrQ1unXQuBA",
    authDomain: "report-jobhk.firebaseapp.com",
    databaseURL: "https://report-jobhk-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "report-jobhk",
    storageBucket: "report-jobhk.appspot.com",
    messagingSenderId: "429684380091",
    appId: "1:429684380091:web:eb390cf661ff974f25f49e",
    measurementId: "G-53EZWY79NL"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const storage = getStorage(app);
const tasksRef = ref(database, "housekeepingTasks");

const floors = {
    3: Array.from({length: 10}, (_, i) => 301 + i),
    4: Array.from({length: 10}, (_, i) => 401 + i),
    5: Array.from({length: 8}, (_, i) => 501 + i),
    6: Array.from({length: 8}, (_, i) => 601 + i)
};
const taskTypes = ['‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á','‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°','‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô','‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î','‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'];

let tasks = [];
let currentTab = 'tasks';

// Initialize
async function initializeAndLoad() {
    onValue(tasksRef, snapshot => {
        const data = snapshot.val();
        tasks = data ? Object.values(data) : [];
        if (tasks.length === 0) createInitialTasks();
        else renderPage();
    });
}

// Create initial tasks
function createInitialTasks() {
    const tasksObject = {};
    Object.keys(floors).forEach(floor => {
        floors[floor].forEach(room => {
            taskTypes.forEach(taskType => {
                const taskId = `${floor}-${room}-${taskType}`;
                tasksObject[taskId] = {
                    id: taskId,
                    floor: floor,
                    room: room,
                    taskType: taskType,
                    status: 'pending',
                    reviewStatus: 'pending_review',
                    assignee: '',
                    reviewedBy: '',
                    images: [],
                    completedAt: null,
                    completedBy: '',
                    reviewedAt: null
                };
            });
        });
    });
    set(tasksRef, tasksObject);
}

// Render tasks
function renderTasks() {
    const grid = document.getElementById('tasksGrid');
    const floorFilter = document.getElementById('floorFilter').value;
    const roomFilter = document.getElementById('roomFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    let filtered = tasks;
    if (floorFilter) filtered = filtered.filter(t => t.floor == floorFilter);
    if (roomFilter) filtered = filtered.filter(t => t.room == roomFilter);
    if (statusFilter) filtered = filtered.filter(t => t.status === statusFilter);

    const grouped = {};
    filtered.forEach(t => {
        const key = `${t.floor}-${t.room}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
    });

    grid.innerHTML = '';
    Object.keys(grouped).forEach(key => {
        const roomTasks = grouped[key];
        const [floor, room] = key.split('-');
        const completedCount = roomTasks.filter(t => t.status==='completed').length;
        const totalCount = roomTasks.length;
        const progressPercent = totalCount ? (completedCount/totalCount*100) : 0;

        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-md overflow-hidden fade-in';
        card.innerHTML = `
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b">
                            <th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th><th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th><th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${roomTasks.map(t=>`
                        <tr class="border-b ${t.status==='completed'?'bg-green-100':''}">
                            <td>${t.taskType}</td>
                            <td>
                                <input type="text" value="${t.assignee}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" ${t.status==='completed'?'disabled':''} onchange="updateAssignee('${t.id}', this.value)"
                                class="w-full px-2 py-1 border rounded text-xs ${t.status==='completed'?'bg-gray-100':''}">
                            </td>
                            <td>
                                <div class="flex items-center space-x-2">
                                    <label class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 cursor-pointer">
                                        üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ
                                        <input type="file" multiple accept="image/*" class="sr-only" onchange="Array.from(this.files).forEach(f=>uploadFile(f,tasks.find(x=>x.id==='${t.id}')))">
                                    </label>
                                    ${t.images && t.images.length>0?`<button onclick="viewImages('${t.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ (${t.images.length})</button>`:''}
                                </div>
                            </td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${t.status==='completed'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${t.status==='completed'?'
                                ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß':'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}</span>
                            </td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${t.reviewStatus==='approved'?'bg-green-100 text-green-800':t.reviewStatus==='rejected'?'bg-red-100 text-red-800':'bg-gray-100 text-gray-600'}">
                                    ${t.reviewStatus==='approved'?'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':t.reviewStatus==='rejected'?'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò':'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}
                                </span>
                            </td>
                            <td>
                                ${t.status==='pending'?`<button onclick="markCompleted('${t.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à</button>`:''}
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div class="mt-2 text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á: ${completedCount}/${totalCount} ‡∏á‡∏≤‡∏ô (${progressPercent.toFixed(0)}%)</div>
            </div>
        `;
        grid.appendChild(card);
    });

    updateProgressBar();
}

// Update overall progress
function updateProgressBar() {
    const completed = tasks.filter(t=>t.status==='completed').length;
    const total = tasks.length;
    const percent = total ? (completed/total*100).toFixed(0) : 0;
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').innerText = percent + '%';
}

// Tab switch
function showTab(tab) {
    currentTab = tab;
    document.getElementById('tasksContent').classList.toggle('hidden', tab!=='tasks');
    document.getElementById('summaryContent').classList.toggle('hidden', tab!=='summary');
    document.getElementById('tasksTab').classList.toggle('bg-blue-500 text-white', tab==='tasks');
    document.getElementById('tasksTab').classList.toggle('bg-gray-200 text-gray-700', tab!=='tasks');
    document.getElementById('summaryTab').classList.toggle('bg-blue-500 text-white', tab==='summary');
    document.getElementById('summaryTab').classList.toggle('bg-gray-200 text-gray-700', tab!=='summary');
    if(tab==='summary') renderSummary();
}

// Mark task completed
function markCompleted(taskId){
    const task = tasks.find(t=>t.id===taskId);
    if(task){
        task.status='completed';
        task.completedAt = new Date().toISOString();
        update(ref(database, 'housekeepingTasks/'+taskId), task);
    }
}

// Update assignee
function updateAssignee(taskId, name){
    const task = tasks.find(t=>t.id===taskId);
    if(task){
        task.assignee = name;
        update(ref(database, 'housekeepingTasks/'+taskId), task);
    }
}

// Upload image
async function uploadFile(file, task){
    const storageReference = storageRef(storage, `housekeeping/${task.id}/${Date.now()}_${file.name}`);
    await uploadBytes(storageReference, file);
    const url = await getDownloadURL(storageReference);
    task.images = task.images || [];
    task.images.push(url);
    update(ref(database, 'housekeepingTasks/'+task.id), task);
}

// View images
function viewImages(taskId){
    const task = tasks.find(t=>t.id===taskId);
    const modal = document.getElementById('imageModal');
    const container = document.getElementById('imageModalContent');
    container.innerHTML = '';
    task.images.forEach(url=>{
        const img = document.createElement('img');
        img.src = url;
        img.className = 'w-full rounded-lg image-preview cursor-pointer';
        container.appendChild(img);
    });
    modal.classList.remove('hidden');
}
function closeImageModal(){ document.getElementById('imageModal').classList.add('hidden'); }

// Reset all tasks
function resetAllTasks(){
    if(confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
        tasks.forEach(t=>{
            t.status='pending';
            t.assignee='';
            t.images=[];
            t.completedAt=null;
            t.completedBy='';
            t.reviewStatus='pending_review';
        });
        set(tasksRef, Object.fromEntries(tasks.map(t=>[t.id,t])));
    }
}

// Render summary
function renderSummary(){
    const stats = document.getElementById('summaryStats');
    const totalTasks = tasks.length;
    const completed = tasks.filter(t=>t.status==='completed').length;
    const pending = totalTasks - completed;
    const approved = tasks.filter(t=>t.reviewStatus==='approved').length;
    const rejected = tasks.filter(t=>t.reviewStatus==='rejected').length;
    const waiting = tasks.filter(t=>t.reviewStatus==='pending_review').length;

    stats.innerHTML = `
        <div class="bg-blue-100 text-blue-800 rounded-lg p-4 text-center font-medium">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br>${totalTasks}</div>
        <div class="bg-green-100 text-green-800 rounded-lg p-4 text-center font-medium">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß<br>${completed}</div>
        <div class="bg-red-100 text-red-800 rounded-lg p-4 text-center font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à<br>${pending}</div>
        <div class="bg-green-200 text-green-900 rounded-lg p-4 text-center font-medium">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br>${approved}</div>
        <div class="bg-red-200 text-red-900 rounded-lg p-4 text-center font-medium">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò<br>${rejected}</div>
        <div class="bg-gray-100 text-gray-800 rounded-lg p-4 text-center font-medium">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>${waiting}</div>
    `;
}

function renderPage(){
    renderTasks();
    if(currentTab==='summary') renderSummary();
}

// Floor-room filter dynamic
document.getElementById('floorFilter').addEventListener('change', e=>{
    const floor = e.target.value;
    const roomSelect = document.getElementById('roomFilter');
    roomSelect.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>`;
    if(floors[floor]) floors[floor].forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r; opt.innerText = r;
        roomSelect.appendChild(opt);
    });
    renderTasks();
});
document.getElementById('roomFilter').addEventListener('change', renderTasks);
document.getElementById('statusFilter').addEventListener('change', renderTasks);

// Start
initializeAndLoad();
</script>
</body>
</html>
