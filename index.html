<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body { font-family: 'Sarabun', sans-serif; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.image-preview { transition: all 0.3s ease; }
.image-preview:hover { transform: scale(1.05); }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="bg-white shadow-lg border-b-4 border-blue-500">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <div class="flex justify-center mt-4 space-x-4">
            <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
            <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<div id="tasksContent" class="container mx-auto px-4 pb-8">
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
            </select>
            <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
            <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            </select>
            <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>

<div id="summaryContent" class="container mx-auto px-4 pb-8 hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>
        <div id="summaryTable" class="overflow-x-auto"></div>
    </div>
</div>

<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-full max-h-full overflow-auto">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="imageModalContent" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.2.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.2.0/firebase-analytics-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA2szkiP9UyOXR7sGa9ov2lpAsykBQqrX0",
  databaseURL: "https://wellreport-8b077-default-rtdb.firebaseio.com",
  authDomain: "wellreport-8b077.firebaseapp.com",
  projectId: "wellreport-8b077",
  storageBucket: "wellreport-8b077.appspot.com",
  messagingSenderId: "511028766274",
  appId: "1:511028766274:web:9efa70776fcd11e1646fdb"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let tasks = [];
let currentTab = 'tasks';

// Floors & TaskTypes
const floors = {
  3: Array.from({length: 10}, (_, i) => 301 + i),
  4: Array.from({length: 10}, (_, i) => 401 + i),
  5: Array.from({length: 8}, (_, i) => 501 + i),
  6: Array.from({length: 8}, (_, i) => 601 + i)
};
const taskTypes = ['‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á','‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°','‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô','‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î','‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'];

// Initialize floorFilter options
const floorSelect = document.getElementById('floorFilter');
Object.keys(floors).forEach(f=>floorSelect.innerHTML+=`<option value="${f}">${f}</option>`);

// ====== Load Tasks ======
function saveToDatabase() {
  db.ref("tasks").set(tasks);
}

function initializeTasks() {
  tasks = [];
  Object.keys(floors).forEach(floor=>{
    floors[floor].forEach(room=>{
      taskTypes.forEach(tt=>{
        tasks.push({
          id:`${floor}-${room}-${tt}`,
          floor, room, taskType:tt,
          assignee:'', status:'pending', completedAt:null, completedBy:'',
          reviewStatus:'pending_review', reviewedBy:'', reviewedAt:null,
          images:[]
        });
      });
    });
  });
  saveToDatabase();
}

function loadFromDatabase(){
  const tasksRef = db.ref("tasks");
  tasksRef.on('value', snapshot=>{
    if(snapshot.exists()){
      const data = snapshot.val();
      tasks = Array.isArray(data)? data: Object.values(data);
      console.log('Tasks loaded:', tasks);
      renderTasks();
      if(currentTab==='summary') renderSummary();
    } else {
      console.log('No tasks, initializing...');
      initializeTasks();
    }
  }, error=>{
    console.error('Firebase load error:', error);
  });
}

// ====== Task Functions ======
function updateAssignee(id, value){
  const t = tasks.find(t=>t.id===id);
  if(!t) return; t.assignee=value; saveToDatabase();
}

function updateReviewer(id, value){
  const t = tasks.find(t=>t.id===id);
  if(!t) return; t.reviewedBy=value; saveToDatabase();
}

function toggleTaskStatus(id){
  const t = tasks.find(t=>t.id===id);
  if(!t) return;
  if(t.status==='pending'){
    if(!t.assignee.trim()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à'); return; }
    t.status='completed'; t.completedAt=new Date().toISOString(); t.completedBy=t.assignee;
  } else { t.status='pending'; t.completedAt=null; t.completedBy=''; }
  saveToDatabase(); renderTasks(); if(currentTab==='summary') renderSummary();
}

function toggleReviewStatus(id){
  const t = tasks.find(t=>t.id===id);
  if(!t || t.status!=='completed'){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ'); return; }
  if(!t.reviewedBy.trim()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
  t.reviewStatus = t.reviewStatus==='pending_review'?'reviewed':'pending_review';
  t.reviewedAt = t.reviewStatus==='reviewed'? new Date().toISOString(): null;
  saveToDatabase(); renderTasks(); if(currentTab==='summary') renderSummary();
}

function uploadFile(file, task){
  if(!task.images) task.images=[];
  const reader = new FileReader();
  reader.onload=e=>{ task.images.push(e.target.result); saveToDatabase(); renderTasks(); }
  reader.readAsDataURL(file);
}

function viewImages(id){
  const t = tasks.find(t=>t.id===id);
  if(!t || !t.images.length) return;
  const c = document.getElementById('imageModalContent');
  c.innerHTML = t.images.map(img=>`<img src="${img}" class="w-full mb-2 image-preview">`).join('');
  document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal(){ document.getElementById('imageModal').classList.add('hidden'); }

function resetAllTasks(){
  if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  tasks.forEach(t=>{
    t.status='pending'; t.completedAt=null; t.completedBy=''; t.assignee='';
    t.images=[]; t.reviewStatus='pending_review'; t.reviewedBy=''; t.reviewedAt=null;
  });
  saveToDatabase(); renderTasks();
}

// ====== Render ======
function showTab(tab){
  currentTab=tab;
  document.getElementById('tasksTab').className = tab==='tasks'
    ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
    : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
  document.getElementById('summaryTab').className = tab==='summary'
    ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
    : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
  document.getElementById('tasksContent').classList.toggle('hidden', tab!=='tasks');
  document.getElementById('summaryContent').classList.toggle('hidden', tab!=='summary');
  if(tab==='tasks') renderTasks(); else renderSummary();
}

function renderTasks(){
  const grid=document.getElementById('tasksGrid');
  const floorFilter=document.getElementById('floorFilter').value;
  const roomFilter=document.getElementById('roomFilter').value;
  const statusFilter=document.getElementById('statusFilter').value;

  let filtered=tasks;
  if(floorFilter) filtered=filtered.filter(t=>String(t.floor)===floorFilter);
  if(roomFilter) filtered=filtered.filter(t=>String(t.room)===roomFilter);
  if(statusFilter) filtered=filtered.filter(t=>t.status===statusFilter);

  const grouped={};
  filtered.forEach(t=>{ const k=`${t.floor}-${t.room}`; if(!grouped[k]) grouped[k]=[]; grouped[k].push(t); });

  grid.innerHTML='';
  Object.keys(grouped).forEach(roomKey=>{
    const [floor, room]=roomKey.split('-');
    const roomTasks=grouped[roomKey];
    const completedCount=roomTasks.filter(t=>t.status==='completed').length;
    const totalCount=roomTasks.length;
    const progressPercent = totalCount? (completedCount/totalCount*100):0;

    const roomCard = document.createElement('div');
    roomCard.innerHTML = `
      <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
        <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
        <div class="mt-2">
          <div class="flex justify-between text-sm mb-1">
            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
            <span>${completedCount}/${totalCount} (${Math.round(progressPercent)}%)</span>
          </div>
          <div class="w-full bg-blue-300 rounded-full h-2">
            <div class="bg-white h-2 rounded-full transition-all duration-500" style="width:${progressPercent}%"></div>
          </div>
        </div>
      </div>
      <div class="p-4 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2">‡∏á‡∏≤‡∏ô</th>
              <th class="text-left py-2">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
              <th class="text-left py-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
              <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th>
              <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à</th>
            </tr>
          </thead>
          <tbody>
            ${roomTasks.map(t=>`
              <tr class="border-b">
                <td class="py-2">${t.taskType}</td>
                <td class="py-2">
                  <input type="text" value="${t.assignee}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥" 
                    class="border px-2 py-1 rounded" 
                    onchange="updateAssignee('${t.id}', this.value)">
                </td>
                <td class="py-2">
                  <button onclick="viewImages('${t.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition">‡∏î‡∏π‡∏£‡∏π‡∏õ (${t.images.length})</button>
                  <input type="file" accept="image/*" class="ml-2" onchange="uploadFile(this.files[0], tasks.find(x=>x.id==='${t.id}'))">
                </td>
                <td class="py-2">
                  <button onclick="toggleTaskStatus('${t.id}')" class="px-2 py-1 rounded ${t.status==='completed'?'bg-green-500 text-white':'bg-gray-300'} hover:opacity-80 transition">
                    ${t.status==='completed'?'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à':'‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}
                  </button>
                </td>
                <td class="py-2">
                  <input type="text" value="${t.reviewedBy}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à"
                    class="border px-2 py-1 rounded mb-1" onchange="updateReviewer('${t.id}', this.value)">
                  <button onclick="toggleReviewStatus('${t.id}')" class="px-2 py-1 rounded ${t.reviewStatus==='reviewed'?'bg-green-500 text-white':'bg-gray-300'} hover:opacity-80 transition w-full">
                    ${t.reviewStatus==='reviewed'?'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß':'‚ùå ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'}
                  </button>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;
    roomCard.className='bg-white rounded-lg shadow-md fade-in';
    grid.appendChild(roomCard);
  });

  const total = tasks.length;
  const completed = tasks.filter(t=>t.status==='completed').length;
  const percent = total? Math.round(completed/total*100):0;
  document.getElementById('progressBar').style.width = percent+'%';
  document.getElementById('progressText').textContent = percent+'%';
}

// ====== Summary ======
function renderSummary(){
  const stats=document.getElementById('summaryStats');
  stats.innerHTML='';
  const floorGroups={};
  tasks.forEach(t=>{
    if(!floorGroups[t.floor]) floorGroups[t.floor]=[];
    floorGroups[t.floor].push(t);
  });
  Object.keys(floorGroups).forEach(f=>{
    const floorTasks=floorGroups[f];
    const completed=floorTasks.filter(t=>t.status==='completed').length;
    const total=floorTasks.length;
    const percent=Math.round(completed/total*100);
    const div=document.createElement('div');
    div.className='bg-gradient-to-r from-blue-400 to-green-400 p-4 rounded-lg text-white text-center shadow-md';
    div.innerHTML=`<h3 class="text-xl font-bold">‡∏ä‡∏±‡πâ‡∏ô ${f}</h3><p>${completed}/${total} (${percent}%)</p>`;
    stats.appendChild(div);
  });

  const table=document.getElementById('summaryTable');
  table.innerHTML=`
    <table class="w-full border-collapse text-sm">
      <thead><tr class="bg-gray-200"><th class="p-2 border">‡∏ä‡∏±‡πâ‡∏ô</th><th class="p-2 border">‡∏´‡πâ‡∏≠‡∏á</th><th class="p-2 border">‡∏á‡∏≤‡∏ô</th><th class="p-2 border">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th><th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th><th class="p-2 border">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th><th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à</th></tr></thead>
      <tbody>
        ${tasks.map(t=>`
          <tr class="border-b">
            <td class="p-2 border">${t.floor}</td>
            <td class="p-2 border">${t.room}</td>
            <td class="p-2 border">${t.taskType}</td>
            <td class="p-2 border">${t.assignee}</td>
            <td class="p-2 border">${t.status==='completed'?'‚úÖ':'‚ùå'}</td>
            <td class="p-2 border">${t.reviewedBy}</td>
            <td class="p-2 border">${t.reviewStatus==='reviewed'?'‚úÖ':'‚ùå'}</td>
          </tr>`).join('')}
      </tbody>
    </table>
  `;
}

// ====== Event Listeners ======
document.getElementById('floorFilter').addEventListener('change', e=>{
  const floor=e.target.value;
  const roomSelect=document.getElementById('roomFilter');
  roomSelect.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>';
  if(floor && floors[floor]){
    floors[floor].forEach(r=>roomSelect.innerHTML+=`<option value="${r}">${r}</option>`);
  }
  renderTasks();
});
document.getElementById('roomFilter').addEventListener('change', renderTasks);
document.getElementById('statusFilter').addEventListener('change', renderTasks);

// Load data
loadFromDatabase();
</script>

</body>
</html>
