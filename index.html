<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body { font-family: 'Sarabun', sans-serif; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.image-preview { transition: all 0.3s ease; cursor:pointer; }
.image-preview:hover { transform: scale(1.05); }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- Header -->
<div class="bg-white shadow-lg border-b-4 border-blue-500">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <div class="flex justify-center mt-4 space-x-4">
            <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
</div>

<!-- Progress -->
<div class="container mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
            <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Tasks -->
<div id="tasksContent" class="container mx-auto px-4 pb-8">
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
            </select>
            <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
            <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            </select>
            <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
    <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>

<!-- Summary -->
<div id="summaryContent" class="container mx-auto px-4 pb-8 hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>
        <div id="summaryTable" class="overflow-x-auto"></div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-full max-h-full overflow-auto">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="imageModalContent" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

<!-- Firebase App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import { getDatabase, ref, set, update, get, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDxHYua4i21OV_N5Me_5ORsQrQ1unXQuBA",
  authDomain: "report-jobhk.firebaseapp.com",
  databaseURL: "https://report-jobhk-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "report-jobhk",
  storageBucket: "report-jobhk.firebasestorage.app",
  messagingSenderId: "429684380091",
  appId: "1:429684380091:web:eb390cf661ff974f25f49e",
  measurementId: "G-53EZWY79NL"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);
const tasksRef = ref(database, "housekeepingTasks");

// Floor & Room setup
const floors = {
  3: Array.from({length: 10}, (_, i) => 301 + i),
  4: Array.from({length: 10}, (_, i) => 401 + i),
  5: Array.from({length: 8}, (_, i) => 501 + i),
  6: Array.from({length: 8}, (_, i) => 601 + i)
};
const taskTypes = ['‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á','‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°','‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô','‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î','‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'];

let tasks = [];
let currentTab = 'tasks';

// ========================
// Initialize & Load Tasks
// ========================
// ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
async function initializeAndLoad() {
  const lastResetDateRef = ref(database, 'lastResetDate');
  const snapshot = await get(lastResetDateRef);
  const lastResetDate = snapshot.val();
  const today = new Date().toDateString();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
  if (!lastResetDate || (new Date().getDate() === 1 && today !== lastResetDate)) {
    if (confirm('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
      await resetAllTasks();
      await set(lastResetDateRef, today);
    }
  }

  // Real-time listener: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
  onValue(tasksRef, (snapshot) => {
    const data = snapshot.val();
    tasks = data ? Object.values(data) : [];
    renderPage();
  });
}

// ========================
// Create initial tasks
// ========================
function createInitialTasks() {
  let initialTasks = [];
  Object.keys(floors).forEach(floor => {
    floors[floor].forEach(room => {
      taskTypes.forEach(taskType => {
        const taskId = `${floor}-${room}-${taskType}`;
        initialTasks.push({
          id: taskId,
          floor: floor,
          room: room,
          taskType: taskType,
          status: 'pending',
          reviewStatus: 'pending_review',
          assignee: '',
          reviewedBy: '',
          images: [],
          completedAt: null,
          completedBy: '',
          reviewedAt: null
        });
      });
    });
  });
  const obj = initialTasks.reduce((acc, t) => (acc[t.id]=t, acc), {});
  set(tasksRef, obj);
}

// ========================
// Render Tasks & Summary
// ========================
function renderPage() {
  if (currentTab === 'tasks') renderTasks();
  else renderSummary();
  updateProgress();
}

// ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function resetAllTasks() {
    if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const tasksObject = {};
    Object.keys(floors).forEach(floor => {
        floors[floor].forEach(room => {
            taskTypes.forEach(taskType => {
                const taskId = `${floor}-${room}-${taskType}`;
                tasksObject[taskId] = {
                    id: taskId,
                    floor: floor,
                    room: room,
                    taskType: taskType,
                    status: 'pending',           // ‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
                    reviewStatus: 'pending_review', // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    assignee: '',                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏≥
                    reviewedBy: '',              // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    images: [],                  // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    completedAt: null,
                    completedBy: '',
                    reviewedAt: null
                };
            });
        });
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Database ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    set(tasksRef, tasksObject)
    .then(() => {
        alert('‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    })
    .catch((err) => {
        console.error('‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏á‡∏≤‡∏ô');
    });
}

    
function renderTasks() {
  const grid = document.getElementById('tasksGrid');
  const floorFilter = document.getElementById('floorFilter').value;
  const roomFilter = document.getElementById('roomFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;

  let filteredTasks = tasks;
  if (floorFilter) filteredTasks = filteredTasks.filter(t => t.floor == floorFilter);
  if (roomFilter) filteredTasks = filteredTasks.filter(t => t.room == roomFilter);
  if (statusFilter) filteredTasks = filteredTasks.filter(t => t.status === statusFilter);

  const groupedTasks = {};
  filteredTasks.forEach(task => {
    const key = `${task.floor}-${task.room}`;
    if (!groupedTasks[key]) groupedTasks[key] = [];
    groupedTasks[key].push(task);
  });

  grid.innerHTML = '';
  Object.keys(groupedTasks).forEach(roomKey => {
    const [floor, room] = roomKey.split('-');
    const roomTasks = groupedTasks[roomKey];
    const completedCount = roomTasks.filter(t => t.status === 'completed').length;
    const totalCount = roomTasks.length;
    const progressPercent = totalCount ? (completedCount / totalCount) * 100 : 0;

    const roomCard = document.createElement('div');
    roomCard.className = 'bg-white rounded-lg shadow-md overflow-hidden fade-in';
    roomCard.innerHTML = `
      <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
        <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
        <div class="mt-2">
          <div class="flex justify-between text-sm mb-1">
            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
            <span>${completedCount}/${totalCount} (${Math.round(progressPercent)}%)</span>
          </div>
          <div class="w-full bg-blue-300 rounded-full h-2">
            <div class="bg-white h-2 rounded-full transition-all duration-500" style="width:${progressPercent}%"></div>
          </div>
        </div>
      </div>
      <div class="p-4 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2">‡∏á‡∏≤‡∏ô</th>
              <th class="text-left py-2">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
              <th class="text-left py-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
              <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th>
              <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
              <th class="text-center py-2">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            ${roomTasks.map(task => `
              <tr class="border-b hover:bg-gray-50 ${task.status === 'completed' ? 'bg-green-100' : ''}">
                <td class="py-3 font-medium">${task.taskType}</td>
                <td class="py-3">
                  <input type="text" value="${task.assignee}" onchange="updateAssignee('${task.id}',this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"
                    ${task.status === 'completed' ? 'disabled' : ''} 
                    class="w-full px-2 py-1 border rounded text-xs ${task.status === 'completed' ? 'bg-gray-100 cursor-not-allowed' : 'focus:ring-1 focus:ring-blue-500'}">
                </td>
                <td class="py-3">
                  <div class="flex items-center space-x-2">
                    <label class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 cursor-pointer">
                      üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ
                      <input type="file" id="images-${task.id}" multiple accept="image/*"
                        onchange="Array.from(this.files).forEach(f=>uploadFile(f,tasks.find(t=>t.id==='${task.id}')))" 
                        class="sr-only">
                    </label>
                    ${task.images && task.images.length > 0 ? `<button onclick="viewImages('${task.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ (${task.images.length})</button>` : ''}
                  </div>
                </td>
                <td class="py-3">
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${task.status === 'completed'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
                    ${task.status === 'completed'?'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}
                  </span>
                  ${task.completedAt?`<div class="text-xs text-gray-500 mt-1">${new Date(task.completedAt).toLocaleString('th-TH')}</div>`:''}
                  ${task.completedBy?`<div class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${task.completedBy}</div>` : ''}
                </td>
                <td class="py-3">
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${task.reviewStatus === 'reviewed'?'bg-purple-100 text-purple-800':'bg-red-100 text-red-800'}">
                    ${task.reviewStatus === 'reviewed'?'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß':'‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}
                  </span>
                  ${task.reviewedAt?`<div class="text-xs text-gray-500 mt-1">${new Date(task.reviewedAt).toLocaleString('th-TH')}</div>`:''}
                  ${task.reviewedBy?`<div class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${task.reviewedBy}</div>`:''}
                  <input type="text" value="${task.reviewedBy}" onchange="updateReviewer('${task.id}', this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
                    ${task.reviewStatus === 'reviewed' ? 'disabled' : ''}
                    class="w-full px-2 py-1 border rounded text-xs mt-2 ${task.reviewStatus === 'reviewed' ? 'bg-gray-100 cursor-not-allowed' : 'focus:ring-1 focus:ring-purple-500'}">
                </td>
                <td class="py-3 text-center">
                  <div class="flex flex-col space-y-2">
                    <button onclick="toggleTaskStatus('${task.id}')" class="px-3 py-1 rounded-lg text-xs font-medium transition-colors ${task.status === 'completed' ? 'bg-green-400 text-gray-700 hover:bg-gray-300' : 'bg-red-500 text-white hover:bg-green-600'}">
                      ${task.status === 'completed'?'‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô':'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô'}
                    </button>
                    <button onclick="toggleReviewStatus('${task.id}')" class="px-3 py-1 rounded-lg text-xs font-medium transition-colors ${task.reviewStatus === 'reviewed' ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-red-500 text-white hover:bg-red-600'}">
                      ${task.reviewStatus === 'reviewed'?'‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'}
                    </button>
                  </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
    grid.appendChild(roomCard);
  });
  updateProgress();
}

// ========================
// Progress
// ========================
function updateProgress(){
  const completed = tasks.filter(t => t.status === 'completed').length;
  const total = tasks.length;
  const percent = total ? Math.round((completed / total) * 100) : 0;
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');
  bar.style.width = percent + '%';
  text.textContent = percent + '%';
}

// ========================
// Actions
// ========================
function toggleTaskStatus(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  if (!task.assignee || task.assignee.trim() === '') {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  const newStatus = task.status === 'pending' ? 'completed' : 'pending';
  const updates = {
    status: newStatus,
    completedAt: newStatus === 'completed' ? new Date().toISOString() : null,
    completedBy: newStatus === 'completed' ? task.assignee : '',
  };
  if (newStatus === 'pending') {
    updates.reviewStatus = 'pending_review';
    updates.reviewedBy = '';
    updates.reviewedAt = null;
  }
  update(ref(database, `housekeepingTasks/${taskId}`), updates);
}

function uploadFile(file, task){
  const reader = new FileReader();
  reader.onload = function(e){
    const updatedImages = task.images ? [...task.images, e.target.result] : [e.target.result];
    update(ref(database, `housekeepingTasks/${task.id}`), { images: updatedImages })
      .then(() => {
        task.images = updatedImages; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ local ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        renderTasks();               // ‡∏£‡∏µ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏£‡∏π‡∏õ" ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      });
  }
  reader.readAsDataURL(file);
}

    
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function renderSummary() {
    const statsContainer = document.getElementById('summaryStats');
    const tableContainer = document.getElementById('summaryTable');

    if (!tasks || tasks.length === 0) {
        statsContainer.innerHTML = '<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</p>';
        tableContainer.innerHTML = '';
        return;
    }

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.status === 'completed').length;
    const pendingTasks = totalTasks - completedTasks;
    const reviewedTasks = tasks.filter(t => t.reviewStatus === 'reviewed').length;
    const pendingReviewTasks = completedTasks - reviewedTasks;

    statsContainer.innerHTML = `
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
            <div class="text-2xl font-bold">${totalTasks}</div>
            <div class="text-sm opacity-90">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
            <div class="text-2xl font-bold">${completedTasks}</div>
            <div class="text-sm opacity-90">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
        </div>
        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
            <div class="text-2xl font-bold">${pendingTasks}</div>
            <div class="text-sm opacity-90">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div>
        </div>
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
            <div class="text-2xl font-bold">${reviewedTasks}</div>
            <div class="text-sm opacity-90">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
        <div class="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-4 rounded-lg">
            <div class="text-2xl font-bold">${pendingReviewTasks}</div>
            <div class="text-sm opacity-90">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
        </div>
    `;

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
    const groupedByRoom = {};
    tasks.forEach(task => {
        const key = `${task.floor}-${task.room}`;
        if (!groupedByRoom[key]) groupedByRoom[key] = { completed: 0, total: 0, reviewed: 0, tasks: [] };
        groupedByRoom[key].total++;
        if (task.status === 'completed') groupedByRoom[key].completed++;
        if (task.reviewStatus === 'reviewed') groupedByRoom[key].reviewed++;
        groupedByRoom[key].tasks.push(task);
    });

    tableContainer.innerHTML = `
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left p-3 font-semibold">‡∏´‡πâ‡∏≠‡∏á</th>
                    <th class="text-left p-3 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                    <th class="text-center p-3 font-semibold">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                    <th class="text-center p-3 font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                    <th class="text-center p-3 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                    <th class="text-left p-3 font-semibold">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                </tr>
            </thead>
            <tbody>
                ${Object.keys(groupedByRoom).map(roomKey => {
                    const [floor, room] = roomKey.split('-');
                    const roomData = groupedByRoom[roomKey];
                    const percent = (roomData.completed / roomData.total) * 100;
                    const pendingTasksList = roomData.tasks.filter(t => t.status === 'pending');
                    const reviewedCount = roomData.tasks.filter(t => t.reviewStatus === 'reviewed').length;

                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-medium">${room}</td>
                            <td class="p-3">${floor}</td>
                            <td class="p-3 text-center">
                                <span class="font-bold ${roomData.completed === roomData.total ? 'text-green-600' : 'text-yellow-600'}">
                                    ${roomData.completed}/${roomData.total}
                                </span>
                            </td>
                            <td class="p-3">
                                <div class="flex items-center space-x-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                    </div>
                                    <span class="text-xs font-medium">${Math.round(percent)}%</span>
                                </div>
                            </td>
                            <td class="p-3 text-center">
                                <span class="font-bold ${reviewedCount === roomData.completed ? 'text-purple-600' : 'text-red-600'}">
                                    ${reviewedCount}/${roomData.completed}
                                </span>
                            </td>
                            <td class="p-3">
                                ${pendingTasksList.length > 0 ? 
                                    pendingTasksList.slice(0, 3).map(t => t.taskType).join(', ') + 
                                    (pendingTasksList.length > 3 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${pendingTasksList.length - 3} ‡∏á‡∏≤‡∏ô` : '')
                                    : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'
                                }
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}
    
    
function updateAssignee(id, value) {
  const task = tasks.find(t => t.id === id);
  if (!task || task.status === 'completed') {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
    renderTasks();
    return;
  }
  update(ref(database, `housekeepingTasks/${id}`), { assignee: value });
}

function toggleReviewStatus(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task || task.status !== 'completed') {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ');
    return;
  }
  if (!task.reviewedBy || task.reviewedBy.trim() === '') {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  const newReviewStatus = task.reviewStatus === 'pending_review' ? 'reviewed' : 'pending_review';
  const updates = {
    reviewStatus: newReviewStatus,
    reviewedAt: newReviewStatus === 'reviewed' ? new Date().toISOString() : null,
  };
  update(ref(database, `housekeepingTasks/${taskId}`), updates);
}

function updateReviewer(id, value) {
  const task = tasks.find(t => t.id === id);
  if (!task || task.reviewStatus === 'reviewed') {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ');
    renderTasks();
    return;
  }
  update(ref(database, `housekeepingTasks/${id}`), { reviewedBy: value });
}

// ========================
// Image Upload & Modal
// ========================
function uploadFile(file, task){
  const reader = new FileReader();
  reader.onload = function(e){
    const updatedImages = task.images ? [...task.images, e.target.result] : [e.target.result];
    update(ref(database, `housekeepingTasks/${task.id}`), { images: updatedImages });
  }
  reader.readAsDataURL(file);
}

function viewImages(id){
  const task = tasks.find(t => t.id === id);
  if (!task || !task.images || task.images.length === 0) return;
  const container = document.getElementById('imageModalContent');
  container.innerHTML = task.images.map(img => `<img src="${img}" class="w-full mb-2 image-preview">`).join('');
  document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal(){
  document.getElementById('imageModal').classList.add('hidden');
}

// ========================
// Filters
// ========================
document.getElementById('floorFilter').addEventListener('change', function(){
  const floor = this.value;
  const roomSelect = document.getElementById('roomFilter');
  roomSelect.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>`;
  if(floor && floors[floor]){
    floors[floor].forEach(r => roomSelect.innerHTML += `<option value="${r}">${r}</option>`);
  }
  renderTasks();
});
document.getElementById('roomFilter').addEventListener('change', renderTasks);
document.getElementById('statusFilter').addEventListener('change', renderTasks);

// ========================
// Tab switch
// ========================
function showTab(tab){
  currentTab = tab;
  document.getElementById('tasksTab').className = tab === 'tasks' 
      ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
      : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
  document.getElementById('summaryTab').className = tab === 'summary' 
      ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
      : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
  document.getElementById('tasksContent').classList.toggle('hidden', tab !== 'tasks');
  document.getElementById('summaryContent').classList.toggle('hidden', tab !== 'summary');
  renderPage();
}

// ========================
// Initialize
// ========================
window.updateAssignee = updateAssignee;
window.toggleTaskStatus = toggleTaskStatus;
window.toggleReviewStatus = toggleReviewStatus;
window.updateReviewer = updateReviewer;
window.viewImages = viewImages;
window.closeImageModal = closeImageModal;

initializeAndLoad();
</script>




</body>
</html>
