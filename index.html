<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body { font-family: 'Sarabun', sans-serif; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.image-preview { transition: all 0.3s ease; }
.image-preview:hover { transform: scale(1.05); }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="bg-white shadow-lg border-b-4 border-blue-500">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
    <div class="flex justify-center mt-4 space-x-4">
      <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
        üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
      <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
        üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
      </button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 py-4">
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="flex justify-between items-center mb-2">
      <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
      <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
    </div>
  </div>
</div>

<!-- Filter -->
<div id="tasksContent" class="container mx-auto px-4 pb-8">
  <div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
      </select>
      <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
      </select>
      <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
        <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
      </select>
      <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
        üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
      </button>
    </div>
  </div>
  <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>

<div id="summaryContent" class="container mx-auto px-4 pb-8 hidden"></div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-full max-h-full overflow-auto">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
      <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="imageModalContent" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

// üîπ Firebase config
cconst firebaseConfig = {
    apiKey: "AIzaSyDxHYua4i21OV_N5Me_5ORsQrQ1unXQuBA",
    authDomain: "report-jobhk.firebaseapp.com",
    databaseURL: "https://report-jobhk-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "report-jobhk",
    storageBucket: "report-jobhk.firebasestorage.app",
    messagingSenderId: "429684380091",
    appId: "1:429684380091:web:eb390cf661ff974f25f49e",
    measurementId: "G-53EZWY79NL"
  };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const floors = {
  3: Array.from({length: 10}, (_, i) => 301 + i),
  4: Array.from({length: 10}, (_, i) => 401 + i),
  5: Array.from({length: 8}, (_, i) => 501 + i),
  6: Array.from({length: 8}, (_, i) => 601 + i)
};
const taskTypes = ['‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á','‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°','‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô','‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î','‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'];

let tasks = [];
let currentTab = 'tasks';

// üîπ Initialize tasks & Firebase sync
function initializeTasks(){
  tasks = [];
  Object.keys(floors).forEach(floor=>{
    floors[floor].forEach(room=>{
      taskTypes.forEach(taskType=>{
        const id = `${floor}-${room}-${taskType}`;
        tasks.push({id,floor,room,taskType,status:'pending',assignee:'',completedAt:null,completedBy:'',reviewStatus:'pending_review',reviewedBy:'',reviewedAt:null,images:[]});
        set(ref(db,'tasks/'+id), tasks[tasks.length-1]);
      });
    });
  });
  populateFilterDropdown();
}

function populateFilterDropdown(){
  const floorSelect = document.getElementById('floorFilter');
  Object.keys(floors).forEach(floor=>{
    floorSelect.innerHTML += `<option value="${floor}">‡∏ä‡∏±‡πâ‡∏ô ${floor}</option>`;
  });
}

function loadFromFirebase(){
  const tasksRef = ref(db,'tasks');
  onValue(tasksRef, snapshot=>{
    tasks = [];
    snapshot.forEach(snap=>{
      tasks.push(snap.val());
    });
    renderTasks();
    if(currentTab==='summary') renderSummary();
  });
}

// üîπ Task actions
function saveTask(task){
  update(ref(db,'tasks/'+task.id), task);
}

function toggleTaskStatus(taskId){
  const task = tasks.find(t=>t.id===taskId);
  if(!task) return;
  if(!task.assignee || task.assignee.trim()===''){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô'); return;}
  if(task.status==='pending'){ task.status='completed'; task.completedAt=new Date().toISOString(); task.completedBy=task.assignee;}
  else{ task.status='pending'; task.completedAt=null; task.completedBy=''; task.reviewStatus='pending_review'; task.reviewedBy=''; task.reviewedAt=null;}
  saveTask(task);
}

function toggleReviewStatus(taskId){
  const task = tasks.find(t=>t.id===taskId);
  if(!task) return;
  if(task.status!=='completed'){alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ'); return;}
  if(!task.reviewedBy || task.reviewedBy.trim()===''){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return;}
  task.reviewStatus = task.reviewStatus==='pending_review'?'reviewed':'pending_review';
  task.reviewedAt = task.reviewStatus==='reviewed'?new Date().toISOString():null;
  saveTask(task);
}

function updateAssignee(id,value){ const task = tasks.find(t=>t.id===id); if(task){ task.assignee=value; saveTask(task); } }
function updateReviewer(id,value){ const task = tasks.find(t=>t.id===id); if(task){ task.reviewedBy=value; saveTask(task); } }

function resetAllTasks(){ if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; tasks.forEach(t=>{ t.status='pending'; t.completedAt=null; t.completedBy=''; t.assignee=''; t.images=[]; t.reviewStatus='pending_review'; t.reviewedBy=''; t.reviewedAt=null; saveTask(t); }); }

// üîπ Image upload
function uploadFile(file,task){
  const storageRef = sRef(storage,'taskImages/'+task.id+'/'+file.name);
  uploadBytes(storageRef,file).then(()=>getDownloadURL(storageRef).then(url=>{ task.images.push(url); saveTask(task); }));
}

function viewImages(id){
  const task = tasks.find(t=>t.id===id);
  if(!task || task.images.length===0) return;
  const container = document.getElementById('imageModalContent');
  container.innerHTML = task.images.map(img=>`<img src="${img}" class="w-full mb-2 image-preview">`).join('');
  document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal(){ document.getElementById('imageModal').classList.add('hidden'); }

// üîπ Render
function renderTasks(){
  const grid=document.getElementById('tasksGrid');
  const floorFilter=document.getElementById('floorFilter').value;
  const roomFilter=document.getElementById('roomFilter').value;
  const statusFilter=document.getElementById('statusFilter').value;
  let filtered = tasks;
  if(floorFilter) filtered=filtered.filter(t=>t.floor==floorFilter);
  if(roomFilter) filtered=filtered.filter(t=>t.room==roomFilter);
  if(statusFilter) filtered=filtered.filter(t=>t.status===statusFilter);

  // Update room dropdown
  const roomSelect = document.getElementById('roomFilter');
  roomSelect.innerHTML=`<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>`;
  if(floorFilter && floors[floorFilter]) floors[floorFilter].forEach(r=>roomSelect.innerHTML+=`<option value="${r}">${r}</option>`);

  grid.innerHTML='';
  const grouped={};
  filtered.forEach(t=>{ const key=`${t.floor}-${t.room}`; if(!grouped[key]) grouped[key]=[]; grouped[key].push(t); });
  Object.keys(grouped).forEach(rKey=>{
    const roomTasks = grouped[rKey];
    const [floor,room] = rKey.split('-');
    const completedCount = roomTasks.filter(t=>t.status==='completed').length;
    const totalCount = roomTasks.length;
    const progressPercent = totalCount?completedCount/totalCount*100:0;
    let html=`<div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
      <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
        <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
        <div class="mt-2 flex justify-between text-sm"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span><span>${completedCount}/${totalCount} (${Math.round(progressPercent)}%)</span></div>
        <div class="w-full bg-blue-300 rounded-full h-2"><div class="bg-white h-2 rounded-full" style="width:${progressPercent}%"></div></div>
      </div>
      <div class="p-4 overflow-x-auto">
        <table class="w-full text-sm">
        <thead><tr class="border-b"><th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th><th>Action</th></tr></thead>
        <tbody>${roomTasks.map(task=>`<tr class="border-b hover:bg-gray-50 ${task.status==='completed'?'bg-green-100':''}">
          <td class="py-3 font-medium">${task.taskType}</td>
          <td class="py-3"><input type="text" value="${task.assignee}" onchange="updateAssignee('${task.id}',this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" ${task.status==='completed'?'disabled':''} class="w-full px-2 py-1 border rounded text-xs"></td>
          <td class="py-3"><div class="flex items-center space-x-2">
            <label class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 cursor-pointer">üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ<input type="file" multiple accept="image/*" onchange="Array.from(this.files).forEach(f=>uploadFile(f,tasks.find(t=>t.id==='${task.id}')))" class="sr-only"></label>
            ${task.images.length>0?`<button onclick="viewImages('${task.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ (${task.images.length})</button>`:''}
          </div></td>
          <td class="py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${task.status==='completed'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${task.status==='completed'?'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}</span></td>
          <td class="py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${task.reviewStatus==='reviewed'?'bg-purple-100 text-purple-800':'bg-red-100 text-red-800'}">${task.reviewStatus==='reviewed'?'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß':'‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}</span></td>
          <td class="py-3 space-x-1"><button onclick="toggleTaskStatus('${task.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">${task.status==='completed'?'‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å':'‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à'}</button><button onclick="toggleReviewStatus('${task.id}')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600">${task.reviewStatus==='reviewed'?'‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å':'üìù ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}</button></td>
        </tr>`).join('')}</tbody></table></div></div>`;
    grid.innerHTML += html;
  });
  updateProgress();
}

// üîπ Render summary
function renderSummary(){
  const container = document.getElementById('summaryContent');
  const total = tasks.length;
  const completed = tasks.filter(t=>t.status==='completed').length;
  const pending = total - completed;
  const reviewed = tasks.filter(t=>t.reviewStatus==='reviewed').length;
  const pendingReview = total-reviewed;
  container.innerHTML=`
  <div class="bg-white rounded-lg shadow-md p-4 fade-in">
    <h2 class="text-xl font-bold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-blue-100 p-4 rounded text-center"><h3 class="text-sm font-medium">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="text-2xl font-bold">${total}</p></div>
      <div class="bg-green-100 p-4 rounded text-center"><h3 class="text-sm font-medium">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h3><p class="text-2xl font-bold">${completed}</p></div>
      <div class="bg-red-100 p-4
p-4 rounded text-center"><h3 class="text-sm font-medium">‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</h3><p class="text-2xl font-bold">${pending}</p></div>
      <div class="bg-purple-100 p-4 rounded text-center"><h3 class="text-sm font-medium">‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3><p class="text-2xl font-bold">${reviewed}</p></div>
    </div>
  </div>`;
}

// üîπ Update progress bar
function updateProgress(){
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const completedCount = tasks.filter(t=>t.status==='completed').length;
  const percent = tasks.length ? Math.round((completedCount/tasks.length)*100) : 0;
  progressBar.style.width = percent + '%';
  progressText.textContent = percent + '%';
}

// üîπ Tabs
function showTab(tab){
  currentTab = tab;
  document.getElementById('tasksContent').classList.toggle('hidden', tab!=='tasks');
  document.getElementById('summaryContent').classList.toggle('hidden', tab!=='summary');
  document.getElementById('tasksTab').classList.toggle('bg-blue-500', tab==='tasks');
  document.getElementById('tasksTab').classList.toggle('bg-gray-200', tab!=='tasks');
  document.getElementById('summaryTab').classList.toggle('bg-blue-500', tab==='summary');
  document.getElementById('summaryTab').classList.toggle('bg-gray-200', tab!=='summary');
  if(tab==='summary') renderSummary();
}

// üîπ Initial load
initializeTasks();
loadFromFirebase();
</script>

</body>
</html>
