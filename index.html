<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDsfzKP6MzJXEd1iQyDqPM9qfusAWoq-ks",
            authDomain: "hkreport.firebaseapp.com",
            projectId: "hkreport",
            storageBucket: "hkreport.firebasestorage.app",
            messagingSenderId: "916615894132",
            appId: "1:916615894132:web:20d0c70fe203ff99eaad21"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.db = db;
        window.storage = storage;
        window.firebaseModules = {
            collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc,
            ref, uploadBytes, getDownloadURL
        };

        // Initialize app after Firebase is ready
        window.initializeApp();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .task-completed { background: linear-gradient(135deg, #10b981, #059669); }
        .task-pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .image-preview { transition: all 0.3s ease; }
        .image-preview:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
            <div class="flex justify-center mt-4 space-x-4">
                <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                    üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                    üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="container mx-auto px-4 py-4">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                    </div>
                    <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasksContent" class="container mx-auto px-4 pb-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                    <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                    <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                    <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                    <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
                </select>
                <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                </select>
                <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                    <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
                </select>
                <select id="inspectionFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à</option>
                    <option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                    <option value="approved">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</option>
                    <option value="rejected">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</option>
                </select>
                <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <!-- Tasks Grid -->
        <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Tasks will be generated here -->
        </div>
    </div>

    <!-- Summary Tab -->
    <div id="summaryContent" class="container mx-auto px-4 pb-8 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- Stats will be generated here -->
            </div>
            <div id="summaryTable" class="overflow-x-auto">
                <!-- Summary table will be generated here -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl max-h-full overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
                <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="imageModalContent" class="p-4">
                <!-- Images will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div id="inspectionModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-full overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</h3>
                <button onclick="closeInspectionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="inspectionModalContent" class="p-6">
                <!-- Inspection form will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        // Data structure
        const floors = {
            3: Array.from({length: 10}, (_, i) => 301 + i),
            4: Array.from({length: 10}, (_, i) => 401 + i),
            5: Array.from({length: 8}, (_, i) => 501 + i),
            6: Array.from({length: 8}, (_, i) => 601 + i)
        };

        const taskTypes = [
            '‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á',
            '‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å',
            '‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°',
            '‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô',
            '‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥',
            '‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î',
            '‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'
        ];

        const inspectors = [
            '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å',
            '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô',
            '‡∏ã‡∏∏‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πÄ‡∏ã‡∏≠‡∏£‡πå',
            '‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',
            '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏∞'
        ];

        let tasks = [];
        let currentTab = 'tasks';

        // Initialize tasks
        function initializeTasks() {
            tasks = [];
            Object.keys(floors).forEach(floor => {
                floors[floor].forEach(room => {
                    taskTypes.forEach(taskType => {
                        tasks.push({
                            id: `${floor}-${room}-${taskType}`,
                            floor: floor,
                            room: room,
                            taskType: taskType,
                            status: 'pending',
                            assignee: '',
                            inspectedBy: '',
                            inspectedAt: null,
                            inspectionStatus: 'pending', // pending, approved, rejected
                            inspectionNotes: '',
                            images: [],
                            completedAt: null,
                            completedBy: ''
                        });
                    });
                });
            });
            loadFromStorage();
        }

        // Firebase functions
        async function saveToFirebase() {
            try {
                const { collection, doc, setDoc } = window.firebaseModules;
                
                // Save tasks data
                await setDoc(doc(window.db, 'housekeeping', 'tasks'), {
                    tasks: tasks,
                    lastUpdated: new Date().toISOString(),
                    lastResetDate: new Date().toDateString()
                });
                
                console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
                // Fallback to localStorage
                localStorage.setItem('housekeepingTasks', JSON.stringify(tasks));
                localStorage.setItem('lastResetDate', new Date().toDateString());
            }
        }

        async function loadFromFirebase() {
            try {
                const { doc, getDoc } = window.firebaseModules;
                const docRef = doc(window.db, 'housekeeping', 'tasks');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const lastReset = data.lastResetDate;
                    
                    // Check if we need to reset (first day of month)
                    const today = new Date();
                    const lastResetDate = lastReset ? new Date(lastReset) : null;
                    
                    if (!lastResetDate || (today.getDate() === 1 && today.toDateString() !== lastReset)) {
                        // Reset all tasks on first day of month
                        tasks.forEach(task => {
                            task.status = 'pending';
                            task.completedAt = null;
                            task.completedBy = '';
                        });
                        await saveToFirebase();
                        return;
                    }
                    
                    if (data.tasks) {
                        const savedTasks = data.tasks;
                        tasks.forEach(task => {
                            const savedTask = savedTasks.find(t => t.id === task.id);
                            if (savedTask) {
                                Object.assign(task, savedTask);
                            }
                        });
                    }
                    
                    console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase, ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà');
                    await saveToFirebase();
                }
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('housekeepingTasks');
                if (saved) {
                    const savedTasks = JSON.parse(saved);
                    tasks.forEach(task => {
                        const savedTask = savedTasks.find(t => t.id === task.id);
                        if (savedTask) {
                            Object.assign(task, savedTask);
                        }
                    });
                }
            }
        }

        async function uploadImageToFirebase(file, taskId) {
            try {
                const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
                const timestamp = Date.now();
                const fileName = `${taskId}_${timestamp}_${file.name}`;
                const storageRef = ref(window.storage, `task-images/${fileName}`);
                
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                return {
                    name: file.name,
                    url: downloadURL,
                    uploadedAt: new Date().toISOString()
                };
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:', error);
                // Fallback to base64
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve({
                            name: file.name,
                            data: e.target.result,
                            uploadedAt: new Date().toISOString()
                        });
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Setup real-time listener
        function setupRealtimeListener() {
            try {
                const { doc, onSnapshot } = window.firebaseModules;
                const docRef = doc(window.db, 'housekeeping', 'tasks');
                
                onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.tasks) {
                            const savedTasks = data.tasks;
                            tasks.forEach(task => {
                                const savedTask = savedTasks.find(t => t.id === task.id);
                                if (savedTask) {
                                    Object.assign(task, savedTask);
                                }
                            });
                            
                            // Update UI
                            if (currentTab === 'tasks') {
                                renderTasks();
                            } else {
                                renderSummary();
                            }
                        }
                    }
                    updateConnectionStatus('connected');
                }, (error) => {
                    console.error('Real-time listener error:', error);
                    updateConnectionStatus('error');
                });
                
                console.log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-time listener ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                updateConnectionStatus('connected');
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Real-time listener:', error);
                updateConnectionStatus('error');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            
            switch (status) {
                case 'connected':
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs text-green-600">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
                    `;
                    break;
                case 'error':
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <span class="text-xs text-red-600">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</span>
                    `;
                    break;
                default:
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                    `;
            }
        }

        // Render functions
        function renderTasks() {
            const grid = document.getElementById('tasksGrid');
            const floorFilter = document.getElementById('floorFilter').value;
            const roomFilter = document.getElementById('roomFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const inspectionFilter = document.getElementById('inspectionFilter').value;

            let filteredTasks = tasks;
            
            if (floorFilter) {
                filteredTasks = filteredTasks.filter(task => task.floor == floorFilter);
            }
            if (roomFilter) {
                filteredTasks = filteredTasks.filter(task => task.room == roomFilter);
            }
            if (statusFilter) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }
            if (inspectionFilter) {
                filteredTasks = filteredTasks.filter(task => task.inspectionStatus === inspectionFilter);
            }

            // Group by room
            const groupedTasks = {};
            filteredTasks.forEach(task => {
                const key = `${task.floor}-${task.room}`;
                if (!groupedTasks[key]) {
                    groupedTasks[key] = [];
                }
                groupedTasks[key].push(task);
            });

            grid.innerHTML = '';
            Object.keys(groupedTasks).forEach(roomKey => {
                const [floor, room] = roomKey.split('-');
                const roomTasks = groupedTasks[roomKey];
                
                const roomCard = document.createElement('div');
                roomCard.className = 'bg-white rounded-lg shadow-md overflow-hidden fade-in';
                
                const completedCount = roomTasks.filter(t => t.status === 'completed').length;
                const totalCount = roomTasks.length;
                const progressPercent = (completedCount / totalCount) * 100;
                
                roomCard.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                        <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
                        <div class="mt-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                                <span>${completedCount}/${totalCount} (${Math.round(progressPercent)}%)</span>
                            </div>
                            <div class="w-full bg-blue-300 rounded-full h-2">
                                <div class="bg-white h-2 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2">‡∏á‡∏≤‡∏ô</th>
                                        <th class="text-left py-2">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
                                        <th class="text-left py-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                        <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="text-center py-2">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${roomTasks.map(task => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-3 font-medium">${task.taskType}</td>
                                            <td class="py-3">
                                                <input type="text" 
                                                       value="${task.assignee}" 
                                                       onchange="updateAssignee('${task.id}', this.value)"
                                                       placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"
                                                       class="w-full px-2 py-1 border rounded text-xs focus:ring-1 focus:ring-blue-500">
                                            </td>
                                            <td class="py-3">
                                                <div class="flex items-center space-x-2">
                                                    <input type="file" 
                                                           id="images-${task.id}" 
                                                           multiple 
                                                           accept="image/*"
                                                           onchange="handleImageUpload('${task.id}', this.files)"
                                                           class="hidden">
                                                    <button onclick="document.getElementById('images-${task.id}').click()" 
                                                            class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                                        üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ
                                                    </button>
                                                    ${task.images.length > 0 ? `
                                                        <button onclick="viewImages('${task.id}')" 
                                                                class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                                                            üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ (${task.images.length})
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                            <td class="py-3">
                                                <div class="space-y-1">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${task.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                        ${task.status === 'completed' ? '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}
                                                    </span>
                                                    ${task.status === 'completed' ? `
                                                        <span class="block px-2 py-1 rounded-full text-xs font-medium ${
                                                            task.inspectionStatus === 'approved' ? 'bg-green-100 text-green-800' :
                                                            task.inspectionStatus === 'rejected' ? 'bg-red-100 text-red-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }">
                                                            ${
                                                                task.inspectionStatus === 'approved' ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à' :
                                                                task.inspectionStatus === 'rejected' ? '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à' :
                                                                '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'
                                                            }
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                ${task.completedAt ? `<div class="text-xs text-gray-500 mt-1">${new Date(task.completedAt).toLocaleString('th-TH')}</div>` : ''}
                                                ${task.completedBy ? `<div class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${task.completedBy}</div>` : ''}
                                                ${task.inspectedBy ? `<div class="text-xs text-purple-600">‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏î‡∏¢: ${task.inspectedBy}</div>` : ''}
                                                ${task.inspectedAt ? `<div class="text-xs text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(task.inspectedAt).toLocaleString('th-TH')}</div>` : ''}
                                                ${task.inspectionNotes ? `<div class="text-xs text-blue-600 mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${task.inspectionNotes}</div>` : ''}
                                            </td>
                                            <td class="py-3 text-center">
                                                <div class="space-y-1">
                                                    <button onclick="toggleTaskStatus('${task.id}')" 
                                                            class="w-full px-2 py-1 rounded text-xs font-medium transition-colors ${task.status === 'completed' ? 'bg-gray-200 text-gray-700 hover:bg-gray-300' : 'bg-green-500 text-white hover:bg-green-600'}">
                                                        ${task.status === 'completed' ? '‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à'}
                                                    </button>
                                                    ${task.status === 'completed' ? `
                                                        <button onclick="openInspectionModal('${task.id}')" 
                                                                class="w-full px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                                    task.inspectionStatus === 'approved' ? 'bg-green-500 text-white hover:bg-green-600' :
                                                                    task.inspectionStatus === 'rejected' ? 'bg-red-500 text-white hover:bg-red-600' :
                                                                    'bg-blue-500 text-white hover:bg-blue-600'
                                                                }">
                                                            üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                grid.appendChild(roomCard);
            });
            
            updateProgress();
        }

        function renderSummary() {
            const statsContainer = document.getElementById('summaryStats');
            const tableContainer = document.getElementById('summaryTable');
            
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const pendingTasks = totalTasks - completedTasks;
            const progressPercent = (completedTasks / totalTasks) * 100;
            
            // Stats cards
            statsContainer.innerHTML = `
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold">${totalTasks}</div>
                    <div class="text-sm opacity-90">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold">${completedTasks}</div>
                    <div class="text-sm opacity-90">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
                </div>
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold">${pendingTasks}</div>
                    <div class="text-sm opacity-90">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold">${Math.round(progressPercent)}%</div>
                    <div class="text-sm opacity-90">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                </div>
            `;
            
            // Summary table
            const groupedByRoom = {};
            tasks.forEach(task => {
                const key = `${task.floor}-${task.room}`;
                if (!groupedByRoom[key]) {
                    groupedByRoom[key] = { completed: 0, total: 0, tasks: [] };
                }
                groupedByRoom[key].total++;
                if (task.status === 'completed') {
                    groupedByRoom[key].completed++;
                }
                groupedByRoom[key].tasks.push(task);
            });
            
            tableContainer.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left p-3 font-semibold">‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="text-left p-3 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                            <th class="text-center p-3 font-semibold">‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th class="text-center p-3 font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                            <th class="text-left p-3 font-semibold">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(groupedByRoom).map(roomKey => {
                            const [floor, room] = roomKey.split('-');
                            const roomData = groupedByRoom[roomKey];
                            const percent = (roomData.completed / roomData.total) * 100;
                            const pendingTasks = roomData.tasks.filter(t => t.status === 'pending');
                            
                            return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3 font-medium">${room}</td>
                                    <td class="p-3">${floor}</td>
                                    <td class="p-3 text-center">
                                        <span class="font-bold ${roomData.completed === roomData.total ? 'text-green-600' : 'text-yellow-600'}">
                                            ${roomData.completed}/${roomData.total}
                                        </span>
                                    </td>
                                    <td class="p-3">
                                        <div class="flex items-center space-x-2">
                                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <span class="text-xs font-medium">${Math.round(percent)}%</span>
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        ${pendingTasks.length > 0 ? 
                                            pendingTasks.slice(0, 3).map(t => t.taskType).join(', ') + 
                                            (pendingTasks.length > 3 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${pendingTasks.length - 3} ‡∏á‡∏≤‡∏ô` : '')
                                            : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Event handlers
        async function updateAssignee(taskId, assignee) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.assignee = assignee;
                await saveToFirebase();
            }
        }



        function openInspectionModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = document.getElementById('inspectionModal');
            const content = document.getElementById('inspectionModalContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${task.room} (‡∏ä‡∏±‡πâ‡∏ô ${task.floor})</div>
                            <div><strong>‡∏á‡∏≤‡∏ô:</strong> ${task.taskType}</div>
                            <div><strong>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</strong> ${task.assignee}</div>
                            <div><strong>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> ${task.inspectedBy || '-'}</div>
                            <div><strong>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${task.completedAt ? new Date(task.completedAt).toLocaleString('th-TH') : '-'}</div>
                            <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> 
                                <span class="px-2 py-1 rounded-full text-xs ${
                                    task.inspectionStatus === 'approved' ? 'bg-green-100 text-green-800' :
                                    task.inspectionStatus === 'rejected' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${
                                        task.inspectionStatus === 'approved' ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à' :
                                        task.inspectionStatus === 'rejected' ? '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à' :
                                        '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'
                                    }
                                </span>
                            </div>
                        </div>
                    </div>

                    ${task.images.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô (${task.images.length} ‡∏£‡∏π‡∏õ)</h4>
                            <div class="grid grid-cols-3 gap-2">
                                ${task.images.slice(0, 6).map(img => `
                                    <img src="${img.url || img.data}" alt="${img.name}" 
                                         class="w-full h-20 object-cover rounded border cursor-pointer hover:opacity-75"
                                         onclick="viewImages('${task.id}')">
                                `).join('')}
                                ${task.images.length > 6 ? `<div class="w-full h-20 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-600">+${task.images.length - 6} ‡∏£‡∏π‡∏õ</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                        <input type="text" 
                               id="inspectorName-${task.id}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
                               value="${task.inspectedBy || ''}"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                        <textarea id="inspectionNotes-${task.id}" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  rows="3" 
                                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">${task.inspectionNotes || ''}</textarea>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="updateInspectionStatus('${task.id}', 'approved')" 
                                class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors font-medium">
                            ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
                        </button>
                        <button onclick="updateInspectionStatus('${task.id}', 'rejected')" 
                                class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                            ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
                        </button>
                        <button onclick="updateInspectionStatus('${task.id}', 'pending')" 
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            ‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeInspectionModal() {
            document.getElementById('inspectionModal').classList.add('hidden');
        }

        async function updateInspectionStatus(taskId, status) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const inspectorNameElement = document.getElementById(`inspectorName-${taskId}`);
                const notesElement = document.getElementById(`inspectionNotes-${taskId}`);
                
                const inspectorName = inspectorNameElement ? inspectorNameElement.value.trim() : '';
                const notes = notesElement ? notesElement.value : '';
                
                if (!inspectorName) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                    return;
                }
                
                task.inspectionStatus = status;
                task.inspectionNotes = notes;
                task.inspectedBy = inspectorName;
                task.inspectedAt = new Date().toISOString();
                
                await saveToFirebase();
                closeInspectionModal();
                renderTasks();
                if (currentTab === 'summary') {
                    renderSummary();
                }
            }
        }

        async function handleImageUpload(taskId, files) {
            const task = tasks.find(t => t.id === taskId);
            if (task && files.length > 0) {
                const uploadPromises = Array.from(files).map(async (file) => {
                    if (file.type.startsWith('image/') && task.images.length < 10) {
                        try {
                            // Show loading indicator
                            const loadingDiv = document.createElement('div');
                            loadingDiv.className = 'text-xs text-blue-600 mt-1';
                            loadingDiv.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${file.name}...`;
                            document.querySelector(`#images-${taskId}`).parentNode.appendChild(loadingDiv);
                            
                            const imageData = await uploadImageToFirebase(file, taskId);
                            task.images.push(imageData);
                            
                            // Remove loading indicator
                            loadingDiv.remove();
                            
                            return imageData;
                        } catch (error) {
                            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:', error);
                            return null;
                        }
                    }
                });
                
                await Promise.all(uploadPromises);
                await saveToFirebase();
                renderTasks();
            }
        }

        function viewImages(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.images.length > 0) {
                const modal = document.getElementById('imageModal');
                const content = document.getElementById('imageModalContent');
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${task.images.map((img, index) => `
                            <div class="border rounded-lg overflow-hidden">
                                <img src="${img.url || img.data}" alt="${img.name}" class="w-full h-48 object-cover image-preview" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuC4o+C4ueC4m+C5hOC4oeC5iOC4quC4suC4oeC4suC4o+C4luC5guC4q+C4peC4lOC5hOC4lOC5iDwvdGV4dD48L3N2Zz4='; this.alt='‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ';">
                                <div class="p-2 bg-gray-50">
                                    <div class="text-xs text-gray-600">${img.name}</div>
                                    <div class="text-xs text-gray-500">${new Date(img.uploadedAt).toLocaleString('th-TH')}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        async function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                if (task.status === 'pending') {
                    if (!task.assignee.trim()) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à');
                        return;
                    }
                    task.status = 'completed';
                    task.completedAt = new Date().toISOString();
                    task.completedBy = task.assignee;
                } else {
                    task.status = 'pending';
                    task.completedAt = null;
                    task.completedBy = '';
                }
                await saveToFirebase();
                renderTasks();
                if (currentTab === 'summary') {
                    renderSummary();
                }
            }
        }

        async function resetAllTasks() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) {
                tasks.forEach(task => {
                    task.status = 'pending';
                    task.completedAt = null;
                    task.completedBy = '';
                    task.inspectionStatus = 'pending';
                    task.inspectedAt = null;
                    task.inspectedBy = '';
                    task.inspectionNotes = '';
                });
                await saveToFirebase();
                renderTasks();
                if (currentTab === 'summary') {
                    renderSummary();
                }
            }
        }

        function updateProgress() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const progressPercent = (completedTasks / totalTasks) * 100;
            
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = Math.round(progressPercent) + '%';
        }

        function updateRoomFilter() {
            const floorFilter = document.getElementById('floorFilter').value;
            const roomFilter = document.getElementById('roomFilter');
            
            roomFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>';
            
            if (floorFilter) {
                floors[floorFilter].forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = `‡∏´‡πâ‡∏≠‡∏á ${room}`;
                    roomFilter.appendChild(option);
                });
            } else {
                Object.keys(floors).forEach(floor => {
                    floors[floor].forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = `‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})`;
                        roomFilter.appendChild(option);
                    });
                });
            }
        }

        function showTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.getElementById('tasksTab').className = tab === 'tasks' 
                ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
                : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
            
            document.getElementById('summaryTab').className = tab === 'summary' 
                ? 'px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors'
                : 'px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors';
            
            // Show/hide content
            document.getElementById('tasksContent').classList.toggle('hidden', tab !== 'tasks');
            document.getElementById('summaryContent').classList.toggle('hidden', tab !== 'summary');
            
            if (tab === 'tasks') {
                renderTasks();
            } else {
                renderSummary();
            }
        }

        // Event listeners
        document.getElementById('floorFilter').addEventListener('change', function() {
            updateRoomFilter();
            renderTasks();
        });

        document.getElementById('roomFilter').addEventListener('change', renderTasks);
        document.getElementById('statusFilter').addEventListener('change', renderTasks);
        document.getElementById('inspectionFilter').addEventListener('change', renderTasks);

        // Close modal when clicking outside
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        document.getElementById('inspectionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInspectionModal();
            }
        });

        // Initialize app
        window.initializeApp = async function() {
            initializeTasks();
            await loadFromFirebase();
            setupRealtimeListener();
            updateRoomFilter();
            renderTasks();
        };

        // Fallback initialization if Firebase fails
        if (!window.initializeApp) {
            setTimeout(() => {
                initializeTasks();
                updateRoomFilter();
                renderTasks();
            }, 1000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9772c5e007bc272d',t:'MTc1NjU0MTAyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
